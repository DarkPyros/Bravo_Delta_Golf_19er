/**************************************************************************
*  
*             ITU-T SOFTWARE TOOLS' GENERAL PUBLIC LICENSE                  
*
*  This "General Public License" is published in the Annex 1 of the
*  ITU-T Recommendation on "SOFTWARE TOOLS FOR HOMOGENITY OF RESULTS
*  IN THE STANDARDIZATION PROCESS OF SPEECH AND AUDIO CODERS",
*  approved in Geneva, 2000.
*
*  TERMS AND CONDITIONS
*
*  1. This License Agreement applies to any module or other work
*  related to the ITU-T Software Tool Library, and developed by the
*  User's Group on Software Tools. The "Module", below, refers to any
*  such module or work, and a "work based on the Module" means either
*  the Module or any work containing the Module or a portion of it,
*  either verbatim or with modifications.  Each licensee is addressed
*  as "you".
*
*  2. You may copy and distribute verbatim copies of the Module's
*  source code as you receive it, in any medium, provided that you:
*  -  conspicuously and appropriately publish on each copy an appropriate
*     copyright notice and disclaimer of warranty;
*  -  keep intact all the notices that refer to this General Public
*     License and to the absence of any warranty; and
*  -  give any other recipients of the Module a copy of this General
*     Public License along with the Module.
*  You may charge a fee for the physical act of transferring a copy.
*
*  3. You may modify your copy or copies of the Module or any portion
*  of it, and copy and distribute such modifications under the terms
*  of Paragraph 1 above, provided that you also do the following:
*
*      o  cause the modified files to carry prominent notices stating
*      that you changed the files and the date of any change; and
*
*      o  cause the whole of any work that you distribute or publish,
*      that in whole or in part contains the Module or any part
*      thereof, either with or without modifications, to be licensed
*      at no charge to all third parties under the terms of this
*      General Public License (except that you may choose to grant
*      warranty protection to some or all third parties, at your
*      option).
*
*      o  If the modified module normally reads commands interactively
*      when run, you must cause it, when started running for such
*      interactive use in the simplest and most usual way, to print or
*      display an announcement including an appropriate copyright
*      notice and a notice that there is no warranty (or else, saying
*      that you provide a warranty) and that users may redistribute
*      the module under these conditions, and telling the user how to
*      view a copy of this General Public License.
*
*  You may charge a fee for the physical act of transferring a copy,
*  and you may at your option offer warranty protection in exchange
*  for a fee.
*
*  Mere aggregation of another independent work with the Module (or
*  its derivative) on a volume of a storage or distribution medium
*  does not bring the other work under the scope of these terms.
*
*  4.  You may copy and distribute the Module (or a portion or
*  derivative of it, under Paragraph 2) in object code or executable
*  form under the terms of Paragraphs 1 and 2 above provided that you
*  also do one of the following:
*
*      o  accompany it with the complete corresponding machine-
*      readable source code, which must be distributed under the terms
*      of Paragraphs 1 and 2 above; or,
*
*      o  accompany it with a written offer, valid for at least three
*      years, to give any third party free (except for a nominal
*      charge for the cost of distribution) a complete machine-
*      readable copy of the corresponding source code, to be
*      distributed under the terms of Paragraphs 1 and 2 above; or,
*
*      o  accompany it with the information you received as to where
*      the corresponding source code may be obtained.  (This
*      alternative is allowed only for noncommercial distribution and
*      only if you received the module in object code or executable
*      form alone.) 
*
*  Source code for a work means the preferred form of the work for
*  making modifications to it.  For an executable file, complete
*  source code means all the source code for all modules it contains;
*  but, as a special exception, it need not include source code for
*  modules which are standard libraries that accompany the operating
*  system on which the executable file runs, or for standard header
*  files or definitions files that accompany that operating system.
*
*  5.  You may not copy, modify, sublicense, distribute or transfer
*  the Module except as expressly provided under this General Public
*  License. Any attempt otherwise to copy, modify, sublicense,
*  distribute or transfer the Module is void, and will automatically
*  terminate your rights to use the Module under this License. 
*  However, parties who have received copies, or rights to use copies,
*  from you under this General Public License will not have their
*  licenses terminated so long as such parties remain in full
*  compliance.
*
*  6.  By copying, distributing or modifying the Module (or any work
*  based on the Module) you indicate your acceptance of this license
*  to do so, and all its terms and conditions.
*
*  7.  Each time you redistribute the Module (or any work based on the
*  Module), the recipient automatically receives a license from the
*  original licensor to copy, distribute or modify the Module subject
*  to these terms and conditions.  You may not impose any further
*  restrictions on the recipients' exercise of the rights granted
*  herein.
*
*  8.  The ITU-T may publish revised and/or new versions of this
*  General Public License from time to time.  Such new versions will
*  be similar in spirit to the present version, but may differ in
*  detail to address new problems or concerns.
*
*  Each version is given a distinguishing version number. If the
*  Module specifies a version number of the license which applies to
*  it and "any later version", you have the option of following the
*  terms and conditions either of that version or of any later version
*  published by the ITU-T. If the Module does not specify a version
*  number of the license, you may choose any version ever published by
*  the ITU-T.
*
*  9.  If you wish to incorporate parts of the Module into other free
*  modules whose distribution conditions are different, write to the
*  author to ask for permission.  For software which is copyrighted by
*  the ITU-T, write to the ITU-T Secretariat; exceptions may be made
*  for this. This decision will be guided by the two goals of
*  preserving the free status of all derivatives of this free software
*  and of promoting the sharing and reuse of software generally.
*
*
*  NO WARRANTY
*
*  10. BECAUSE THE MODULE IS LICENSED FREE OF CHARGE, THERE IS NO
*  WARRANTY FOR THE MODULE, TO THE EXTENT PERMITTED BY APPLICABLE LAW. 
*  EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS
*  AND/OR OTHER PARTIES PROVIDE THE MODULE "AS IS" WITHOUT WARRANTY OF
*  ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED
*  TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
*  PARTICULAR PURPOSE.  THE ENTIRE RISK AS TO THE QUALITY AND
*  PERFORMANCE OF THE MODULE IS WITH YOU.  SHOULD THE MODULE PROVE
*  DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING, REPAIR
*  OR CORRECTION.
*
*  11. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN
*  WRITING WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY
*  MODIFY AND/OR REDISTRIBUTE THE MODULE AS PERMITTED ABOVE, BE LIABLE
*  TO YOU FOR DAMAGES, INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR
*  CONSEQUENTIAL DAMAGES ARISING OUT OF THE USE OR INABILITY TO USE
*  THE MODULE (INCLUDING BUT NOT LIMITED TO LOSS OF DATA OR DATA BEING
*  RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD PARTIES OR
*  A FAILURE OF THE MODULE TO OPERATE WITH ANY OTHER MODULES), EVEN IF
*  SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF
*  SUCH DAMAGES.
*
*  END OF TERMS AND CONDITIONS
***************************************************************************/

#include "..\h\includes.h"

/* Disable clock write protection
 * Select Primary osc w/ PLL
 * Clock switch enabled, OSC2 Pin digital I/O, external clock (12 MHZ)
 * Watchdog Time disabled
 */
_FGS(GWRP_OFF & GCP_OFF);
_FOSCSEL(FNOSC_PRIPLL);
_FOSC(FCKSM_CSECMD & OSCIOFNC_ON & POSCMD_EC);
_FWDT(FWDTEN_OFF);

/* PACKED_BYTES - The number of bytes contained in G726A
 *                 packed data array					
 */
#define PACKED_BYTES 20

/* Allocate state memory and IO buffers for G.726A encoder and decoder */
int rawSamples		[G726A_FRAME_SIZE]; 
int decodedSamples	[G726A_FRAME_SIZE];
unsigned char encodedSamples[G726A_FRAME_SIZE];
unsigned char packedData[PACKED_BYTES];
unsigned char encoder[G726A_ENCODER_SIZE];
unsigned char decoder[G726A_DECODER_SIZE];

/* Allocate memory for buffers and drivers
 * codecBuffer - Buffer used by the codec driver
 * flashMemoryBuffer - buffer used by the SFM driver
 * */
int 	codecBuffer		[WM8510DRV_DRV_BUFFER_SIZE];

WM8510Handle codec;
WM8510Handle * codecHandle = &codec;

/* Flags
 * modeSelectFlag - indicates if radio is in transmit mode
 * */			
int modeSelectFlag = IDLE;

/* Index values */
unsigned char i;	

/* Function Declarations */
void audioCodecInit();
void modeCheck();
void selectCodecMode();
void recordMode();
void playbackMode();
void writeToSPI(unsigned char*, int);
void readFromSPI(unsigned char*, int);


int main(void) {
	
	audioCodecInit();
	SPISlaveInit();
	
	/* Main processing loop. */
	while(1) {

		
	}	/* End of main processing loop */
}	/* End of main() */

/* Function definitions */
	/* Initialization of audio controller*/
void audioCodecInit() {
	/* Configure Oscillator to operate the device at 80MHz / 40 MIPS.
	 * Fosc= Fin*M/(N1*N2), Fcy=Fosc/2
	 * Fosc= 12*40/(3*2)=80Mhz for 12MHz input clock */ 
	PLLFBD=38;				/* M = PLLFBD + 2 = 40	*/
	CLKDIVbits.PLLPRE=1;	/* N1 = PLLPRE + 2 = 3	*/
	CLKDIVbits.PLLPOST=0;	/* N2 = PLLPOST + 2 = 2	*/
	OSCTUN=0;			
	
	__builtin_write_OSCCONH(0x01);		/*	Initiate Clock Switch to FRC with PLL*/
	__builtin_write_OSCCONL(0x01);
	while (OSCCONbits.COSC != 0b01);	/*	Wait for Clock switch to occur	*/
	while(!OSCCONbits.LOCK);

	/* Initialize PortB pins as inputs for mode selection */
	PLAYBACK_TRIS  = 1;
	RECORD_TRIS = 1;
	
	/* Initialize the board and the drivers	*/
	SASKInit();
	WM8510Init(codecHandle,codecBuffer);
	
	/* Start Audio input and output function */
	WM8510Start(codecHandle);
		
	/* Configure codec for 8K operation	*/
	WM8510SampleRate8KConfig(codecHandle);

	/* Initialize G.726A Encoder and Decoder. */
	G726AEncoderInit(encoder, G726A_16KBPS, G726A_FRAME_SIZE);
	G726ADecoderInit(decoder, G726A_16KBPS, G726A_FRAME_SIZE);
} /* End of audioCodecInit() */

void modeCheck() {
	
	if(PLAYBACK_FLAG == TRUE) {
		/* Toggle to Playback Mode.
		 * Turn on Green LED and Yellow LED off.
		 * */		 
		YELLOW_LED = SASK_LED_OFF;
		GREEN_LED = SASK_LED_ON;
		modeSelectFlag = PLAYBACK_MODE;						
	}	
	
	else if(RECORD_FLAG == TRUE) {
		/* Toggle Record Mode.
		 * Turn on Yellow LED and Green LED off.
		 * */		 
		YELLOW_LED = SASK_LED_ON;
		GREEN_LED = SASK_LED_OFF;
		modeSelectFlag = RECORD_MODE;							
	}
	
	else {
		/* If not in Playback or Record mode, default to Idle mode. */
		YELLOW_LED = SASK_LED_OFF;
		GREEN_LED = SASK_LED_OFF;
		modeSelectFlag = PLAYBACK_MODE;
	}
}

	/* Select the audio processing mode to run*/
void selectCodecMode() {
	if(modeSelectFlag == PLAYBACK_MODE) {
		playbackMode();
	}
	
	else if(modeSelectFlag == RECORD_MODE) {
		recordMode();
	}
}

	/* Read new frame from codec and encode. */
void recordMode() {
				
	/*Obtain Audio Samples
	while(WM8510IsReadBusy(codecHandle));
	*/
	
	/* Wait till the codec is ready with a new frame */	
	if(WM8510IsReadBusy(codecHandle) == FALSE) {
		
		/* Obtain audio samples from codec */
		WM8510Read(codecHandle, rawSamples, G726A_FRAME_SIZE);				

		/* Scale samples from 16-bit to 14-bit */
		for(i = 0; i < G726A_FRAME_SIZE; i ++)
		{
			// Not necessary if its known that input
			// is 14 bits or less.			
			rawSamples[i] = rawSamples[i] >> 2;
		}

		/* Encode samples*/
		G726AEncode(encoder,rawSamples,encodedSamples);
		
		/* Compresses 80 encoded samples into 20 bytes of data prior to transmission */
		G726APack(encodedSamples, packedData, G726A_FRAME_SIZE, G726A_16KBPS);
		
	}
}	/* End of recordMode() */

	/* Write decoded frame to codec for playback. */
void playbackMode() {
	 
	/* Wait till the codec is available for a new frame	
	while(WM8510IsWriteBusy(codecHandle));	
	*/
	
	/* Wait till the codec is available for a new frame */
	if(WM8510IsWriteBusy(codecHandle) == FALSE) {
	
		/* Uncompress 20 bytes of received data into 80 encoded samples */
		G726AUnpack(packedData, encodedSamples, G726A_FRAME_SIZE, G726A_16KBPS);

		/* Decode the samples*/
		G726ADecode(decoder, encodedSamples, decodedSamples);

		/* Scale sample*/
		for(i = 0; i < G726A_FRAME_SIZE; i ++) 	{
			/* Scale the decoded sample to 
			 * adjust for the 16 to 14-bit scaling done before
			 * encode */
			decodedSamples[i] = decodedSamples[i] << 2;
		}

		/* Write the frame to the output	*/
		WM8510Write (codecHandle,decodedSamples,G726A_FRAME_SIZE);
	}
}	/* End of playbackMode() */

	/* Select if writing or reading from SPI */
void selectSPIMode() {
	if(modeSelectFlag == PLAYBACK_MODE) {
		/* Receive data from SPI and write to packedData array */
		readFromSPI(packedData, PACKED_BYTES);		
	}
	
	else if(modeSelectFlag == RECORD_MODE) {
		/* Transmit data of packedData array over SPI */
		writeToSPI(packedData, PACKED_BYTES);
	}	
}
	/* Transmit an array of data using SPI */
void writeToSPI(unsigned char* data, int size) {
	unsigned char currentByte = 0;
	
	while(currentByte < size) {
		while(!SPI1STATbits.SPITBF);
		
		SPI1BUF = data[currentByte];
		
		currentByte++;
	}
}	/* End of writeToSPI() */

void readFromSPI(unsigned char* data, int size) {
	unsigned char currentByte = 0;
	
	while(currentByte < size) {
		while(!SPI1STATbits.SPIRBF);
		
		data[currentByte] = SPI1BUF;
		
		currentByte++;
	}
}	/* End of readFromSPI() */


/* End of File */
